# EconoNyang 운영 가이드 🐱

**문서명**: EconoNyang 프로덕션 환경 구동 및 운영 매뉴얼  
**작성일**: 2025-08-24  
**목적**: 실제 서비스 운영을 위한 완전한 설정 및 실행 가이드 제공

---

## 🚀 빠른 시작 (Quick Start)

### 1단계: 환경 준비

```bash
# 프로젝트 클론
git clone https://github.com/limcpf/econo-nyang.git
cd econo-nyang

# 필수 소프트웨어 확인
java -version    # Java 8+ 필요
docker --version # Docker 20+ 필요
mvn --version    # Maven 3.6+ 필요
```

### 2단계: 환경 변수 설정

```bash
# 환경 변수 파일 생성
cp .env.example .env

# 필수 환경 변수 설정
cat >> .env << EOF
# OpenAI API 설정 (필수)
OPENAI_API_KEY=sk-your-openai-api-key-here

# Discord Webhook 설정 (필수)  
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/your-webhook-url

# 데이터베이스 설정
DB_URL=jdbc:postgresql://localhost:5432/econyang
DB_USERNAME=econyang
DB_PASSWORD=your-secure-password

# 애플리케이션 설정
SPRING_PROFILES_ACTIVE=prod
LOG_LEVEL=INFO
EOF
```

### 3단계: 데이터베이스 실행

```bash
# PostgreSQL 컨테이너 실행
docker-compose up -d postgres

# 데이터베이스 초기화 대기 (30초)
sleep 30

# Flyway 마이그레이션 실행
./mvnw flyway:migrate
```

### 4단계: 애플리케이션 빌드 및 실행

```bash
# Maven 빌드
./mvnw clean package -DskipTests

# 프로덕션 모드로 실행
java -jar target/econyang-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  --batch.auto-run=true \
  --job.name=ECON_DAILY_DIGEST \
  --targetDate=$(date +%Y-%m-%d) \
  --maxArticles=10 \
  --useLLM=true
```

---

## ⚙️ 상세 설정 가이드

### RSS 소스 설정

**파일**: `src/main/resources/config/rss-sources.yml`

```yaml
sources:
  # 주요 경제 언론사
  - name: "한국경제"
    url: "https://www.hankyung.com/feed/economy"
    weight: 1.2
    enabled: true
    includeKeywords: ["경제", "금융", "증시", "부동산"]
    excludeKeywords: ["광고", "홍보"]

  - name: "매일경제"
    url: "https://www.mk.co.kr/rss/30000001/"
    weight: 1.1
    enabled: true

  - name: "조선비즈"
    url: "https://biz.chosun.com/rss/economy.xml"
    weight: 1.0
    enabled: true

# 필터링 설정
filtering:
  minTitleLength: 10
  maxTitleLength: 150
  duplicateThresholdScore: 0.8
```

### 다이제스트 템플릿 설정

**파일**: `src/main/resources/config/digest-template.yml`

```yaml
templates:
  default:
    title: "📊 오늘의 경제 뉴스 다이제스트"
    header: |
      안녕하세요! 오늘의 주요 경제 뉴스를 정리해드렸습니다. 🐱
      
      📅 **날짜**: {{date}}
      📰 **총 {{totalCount}}개 뉴스** (평균 중요도: {{avgScore}}/10)
      
    itemTemplate: |
      ## {{index}}. {{title}}
      
      **{{source}}** | 중요도: {{score}}/10 | {{timeAgo}}
      
      **📝 요약**: {{summary}}
      
      **🔍 분석**: {{whyItMatters}}
      
      **🏷️ 키워드**: {{#bullets}}• {{.}} {{/bullets}}
      
      [원문 보기]({{url}})
      
      ---
      
    footer: |
      
      💡 **오늘의 인사이트**
      - 가장 주목받은 섹터: {{topSector}}
      - 평균 투자자 관심도: {{avgInterest}}
      
      🤖 *EconoNyang이 AI로 분석한 뉴스입니다*

  simple:
    title: "📈 경제뉴스 요약"
    itemTemplate: |
      **{{title}}** ({{score}}/10)
      {{summary}}
      [링크]({{url}})
```

### OpenAI API 설정

**파일**: `src/main/resources/application-prod.yml`

```yaml
app:
  openai:
    apiKey: ${OPENAI_API_KEY}
    modelMain: gpt-4o           # 메인 모델
    modelSmall: gpt-4o-mini     # 비용 절약용
    maxTokens: 4000             # 최대 토큰 수
    temperature: 0.1            # 일관성 위해 낮게 설정
    requestTimeout: 30s         # 타임아웃 설정
    
  ai:
    summary:
      enabled: true
      minContentLength: 100     # 최소 본문 길이
      maxRetries: 2             # 재시도 횟수
      
  batch:
    step:
      s3-summarize-ai:
        chunkSize: 10           # 배치 청크 크기
        skipLimit: 3            # 스킵 허용 개수
```

---

## 📋 운영 명령어

### 수동 배치 실행

```bash
# 기본 실행 (오늘 날짜, 10개 기사)
java -jar econyang.jar --job.name=ECON_DAILY_DIGEST

# 특정 날짜 실행
java -jar econyang.jar \
  --job.name=ECON_DAILY_DIGEST \
  --targetDate=2025-08-24

# 개수 제한 및 AI 사용
java -jar econyang.jar \
  --job.name=ECON_DAILY_DIGEST \
  --maxArticles=20 \
  --useLLM=true

# DRY RUN 모드 (실제 발송하지 않음)
java -jar econyang.jar \
  --job.name=ECON_DAILY_DIGEST \
  --dryRun=true

# 백필 작업 (과거 데이터 보완)
java -jar econyang.jar \
  --job.name=ECON_BACKFILL \
  --startDate=2025-08-01 \
  --endDate=2025-08-23
```

### 시스템 상태 확인

```bash
# 데이터베이스 연결 확인
psql $DB_URL -c "SELECT COUNT(*) FROM articles;"

# 최근 배치 실행 현황
psql $DB_URL -c "
SELECT job_name, status, start_time, end_time 
FROM batch_job_execution 
ORDER BY start_time DESC LIMIT 5;"

# 오늘 처리된 기사 수
psql $DB_URL -c "
SELECT COUNT(*) as processed_today
FROM articles 
WHERE DATE(created_at) = CURRENT_DATE;"

# OpenAI API 사용량 (애플리케이션 로그에서)
tail -f logs/application.log | grep "API 사용량 통계"
```

---

## 🕐 스케줄링 설정

### Cron 설정 (Linux/macOS)

```bash
# crontab 편집
crontab -e

# 매일 오전 7:30에 실행
30 7 * * * cd /path/to/econo-nyang && java -jar econyang.jar --job.name=ECON_DAILY_DIGEST --maxArticles=15 --useLLM=true >> logs/cron.log 2>&1

# 매주 일요일 오후 11시에 백업
0 23 * * 0 cd /path/to/econo-nyang && pg_dump $DB_URL | gzip > backups/backup_$(date +\%Y\%m\%d).sql.gz
```

### systemd 서비스 (Linux)

**파일**: `/etc/systemd/system/econyang.service`

```ini
[Unit]
Description=EconoNyang Daily Digest Service
After=network.target

[Service]
Type=oneshot
User=econyang
WorkingDirectory=/opt/econyang
Environment=SPRING_PROFILES_ACTIVE=prod
ExecStart=/usr/bin/java -jar econyang.jar --job.name=ECON_DAILY_DIGEST --maxArticles=15 --useLLM=true
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**타이머 설정**: `/etc/systemd/system/econyang.timer`

```ini
[Unit]
Description=Run EconoNyang Daily
Requires=econyang.service

[Timer]
OnCalendar=*-*-* 07:30:00
Persistent=true

[Install]
WantedBy=timers.target
```

```bash
# 서비스 등록 및 시작
sudo systemctl daemon-reload
sudo systemctl enable econyang.timer
sudo systemctl start econyang.timer

# 상태 확인
sudo systemctl status econyang.timer
```

---

## 📊 모니터링 및 알람

### 로그 모니터링

```bash
# 실시간 로그 모니터링
tail -f logs/application.log

# 에러 로그만 확인
tail -f logs/application.log | grep ERROR

# 배치 실행 결과만 확인
tail -f logs/application.log | grep "배치 실행"

# 파일 크기가 큰 로그 로테이션
logrotate -d /etc/logrotate.d/econyang
```

### 성능 지표 모니터링

```sql
-- 일별 처리 성능
SELECT 
  DATE(created_at) as date,
  COUNT(*) as articles_processed,
  COUNT(CASE WHEN content IS NOT NULL THEN 1 END) as extracted_count,
  COUNT(CASE WHEN content IS NOT NULL THEN 1 END) * 100.0 / COUNT(*) as extraction_rate
FROM articles 
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- AI 요약 성공률
SELECT 
  DATE(s.created_at) as date,
  COUNT(*) as total_summaries,
  COUNT(CASE WHEN s.score >= 5 THEN 1 END) as high_quality_count,
  AVG(s.score) as avg_score
FROM summaries s
WHERE s.created_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY DATE(s.created_at)
ORDER BY date DESC;

-- Discord 발송 현황
SELECT 
  DATE(created_at) as date,
  status,
  COUNT(*) as count
FROM daily_digests 
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY DATE(created_at), status
ORDER BY date DESC;
```

### 알람 설정

**파일**: `scripts/health_check.sh`

```bash
#!/bin/bash

# 건강 상태 체크 스크립트
LOG_FILE="/opt/econyang/logs/application.log"
ERROR_COUNT=$(tail -100 $LOG_FILE | grep -c "ERROR")
DB_CONNECTION=$(psql $DB_URL -t -c "SELECT 1;" 2>/dev/null)

if [ "$ERROR_COUNT" -gt 5 ]; then
    echo "⚠️ EconoNyang: 최근 로그에 에러가 많이 발생했습니다 ($ERROR_COUNT개)"
    # Slack/Discord 알람 발송
    curl -X POST $ALERT_WEBHOOK_URL -d "{\"text\":\"EconoNyang 에러 급증: $ERROR_COUNT개\"}"
fi

if [ -z "$DB_CONNECTION" ]; then
    echo "❌ EconoNyang: 데이터베이스 연결 실패"
    curl -X POST $ALERT_WEBHOOK_URL -d "{\"text\":\"EconoNyang DB 연결 실패\"}"
fi

# 디스크 사용량 체크
DISK_USAGE=$(df /opt/econyang | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 80 ]; then
    echo "⚠️ EconoNyang: 디스크 사용량 경고 ($DISK_USAGE%)"
fi
```

---

## 🔧 문제 해결 (Troubleshooting)

### 일반적인 문제들

#### 1. OpenAI API 오류
```bash
# API 키 확인
echo $OPENAI_API_KEY | wc -c  # 51자여야 함

# API 호출 테스트
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
     https://api.openai.com/v1/models

# 로그에서 API 에러 확인
grep "OpenAI API" logs/application.log | tail -10
```

#### 2. Discord Webhook 실패
```bash
# Webhook URL 테스트
curl -X POST $DISCORD_WEBHOOK_URL \
     -H "Content-Type: application/json" \
     -d '{"content":"테스트 메시지"}'

# Rate Limit 확인
grep "Discord.*rate limit" logs/application.log
```

#### 3. 데이터베이스 연결 문제
```bash
# PostgreSQL 상태 확인
docker-compose ps postgres

# 수동 연결 테스트
psql $DB_URL -c "\dt"

# 마이그레이션 상태 확인
./mvnw flyway:info
```

#### 4. RSS 피드 수집 실패
```bash
# RSS 소스별 응답 시간 테스트
for url in $(grep "url:" src/main/resources/config/rss-sources.yml | cut -d'"' -f2); do
  echo "Testing $url"
  curl -I -m 10 "$url"
done

# User-Agent 차단 확인
curl -H "User-Agent: Mozilla/5.0" "RSS_URL"
```

### 로그 레벨 조정

**파일**: `src/main/resources/logback-prod.xml`

```xml
<configuration>
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/application.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/application.%d{yyyy-MM-dd}.gz</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 프로덕션에서는 DEBUG 레벨 제한 -->
    <logger name="com.yourco.econyang" level="INFO" />
    <logger name="com.yourco.econyang.openai" level="DEBUG" />  <!-- OpenAI 호출은 디버깅 -->
    
    <root level="WARN">
        <appender-ref ref="FILE" />
    </root>
</configuration>
```

---

## 💰 비용 최적화

### OpenAI API 비용 관리

```yaml
# application-prod.yml
app:
  openai:
    # 비용 절약을 위한 설정
    modelMain: gpt-4o-mini      # 더 저렴한 모델 우선 사용
    modelSmall: gpt-4o-mini
    maxTokens: 2000             # 토큰 제한 (비용 제어)
    dailyBudget: 5.00           # 일일 예산 제한 (USD)
    
  ai:
    summary:
      costThreshold: 0.01       # 기사당 최대 비용 (USD)
      enableFallback: true      # 비용 초과 시 폴백 요약 사용
```

### 자원 사용량 최적화

```yaml
# application-prod.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 5      # DB 연결 풀 크기 제한
      
  batch:
    step:
      s2-extract:
        throttleLimit: 3        # 동시 HTTP 요청 제한
        
app:
  rss:
    maxArticlesPerSource: 50    # 소스당 최대 기사 수
    requestDelayMs: 1000        # 요청 간 지연
```

---

## 🔒 보안 설정

### 환경 변수 암호화

```bash
# 민감 정보는 시스템 레벨에서 관리
export OPENAI_API_KEY=$(vault kv get -field=api_key secret/econyang)
export DISCORD_WEBHOOK_URL=$(vault kv get -field=webhook_url secret/econyang)

# 또는 systemd에서 EnvironmentFile 사용
# /etc/systemd/system/econyang.service
[Service]
EnvironmentFile=/etc/econyang/environment
```

### 네트워크 보안

```bash
# 방화벽 설정 (iptables)
sudo iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT    # HTTPS
sudo iptables -A OUTPUT -p tcp --dport 5432 -j ACCEPT   # PostgreSQL
sudo iptables -A OUTPUT -j DROP                         # 기타 차단

# 또는 ufw 사용
sudo ufw allow out 443
sudo ufw allow out 5432
sudo ufw deny out
```

---

## 📈 확장성 고려사항

### 수평 확장

```yaml
# 멀티 인스턴스 실행 시
spring:
  batch:
    job:
      repository:
        # 동시성 충돌 방지
        isolation-level: READ_COMMITTED
        
app:
  batch:
    # 인스턴스별 역할 분담
    enabledSteps: ["S1_FETCH", "S2_EXTRACT"]  # 인스턴스 A
    # enabledSteps: ["S3_SUMMARIZE_AI"]       # 인스턴스 B (GPU 서버)
```

### 부하 분산

```bash
# Nginx 설정 예시
upstream econyang_backends {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}

server {
    location /actuator/health {
        proxy_pass http://econyang_backends;
    }
}
```

---

## 📞 지원 및 문의

### 로그 수집 및 지원 요청

```bash
# 지원 요청 시 필요한 정보 수집
./scripts/collect_support_info.sh > support_info.txt

# 내용: 
# - 시스템 정보 (OS, Java 버전)
# - 최근 로그 (민감 정보 제외)
# - 설정 파일 (API 키 마스킹)
# - 데이터베이스 상태
```

### 커뮤니티 및 업데이트

- **GitHub Issues**: 버그 신고 및 기능 요청
- **Releases**: 업데이트 알림 구독 권장  
- **Wiki**: 커뮤니티 운영 노하우 공유

---

**EconoNyang** 🐱 - 안정적인 경제뉴스 자동화로 매일 아침을 시작하세요!