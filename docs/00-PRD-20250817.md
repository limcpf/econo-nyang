좋아. 아래는 **Java + Spring Boot + Spring Batch + Jenkins** 전제로, **OpenAI API를 활용한 요약·해설(설명) 기능**을 포함한 \*\*PRD(제품 요구사항 문서)\*\*이다. 코드는 포함하지 않았고, **성능/비용 최적화 플랜과 프롬프팅 전략**을 상세히 담았다.

# 1) 문서 정보

* 문서명: 전일 경제뉴스 다이제스트(PRD) – AI 요약·해설 포함
* 버전: v1.0 (2025-08-16 KST)
* 소유: 백엔드/데이터팀, 배치/운영팀

# 2) 목적/배경/범위

* 목적: 전일(00:00\~24:00 KST) 경제뉴스를 수집→요약→해설→디스코드 발송. 초보도 이해할 수 있는 친절한 설명 제공.
* 범위: 수집(RSS/공식 피드), 본문(가능 범위) 추출, **AI 요약·해설 생성(OpenAI)**, 중요 기사 선별, 디스코드 임베드 발송, DB 영속화.
* 비범위: 웹 프론트, 장기 백필(대량 과거 재처리), 유료 뉴스 API 의존.

# 3) 주요 사용자 스토리

* “경제 초보”로서, **매일 07:30 KST**에 디스코드에서
  ① 한 장 요약 → ② 왜 중요한가 → ③ 핵심 포인트(3\~5) → ④ 용어풀이 를 보고 싶다.
* 장애 시 원인과 재발송 절차를 쉽게 확인하고 싶다.

# 4) 아키텍처 개요 (Spring Batch + Jenkins, 톰캣 불필요)

* Jenkins 스케줄: 매일 07:30 KST `java -jar`로 배치 Job 실행(파라미터: 대상일, 최대건수, dryRun, LLM on/off 등).
* Spring Batch Job(ECON\_DAILY\_DIGEST):
  S1\_FETCH → S2\_EXTRACT → **S3\_SUMMARIZE\_AI** → S4\_RANK\_COMPOSE → S5\_DISPATCH
* DB(PostgreSQL 권장): `articles`, `summaries`, `daily_digest`, `dispatch_log` 등.

# 5) 기능 요구사항(FR)

* FR1 전일 기사 수집(Asia/Seoul 기준), URL 중복 제거.
* FR2 본문 추출 실패 시 **헤드라인 기반 최소 요약** 폴백.
* FR3 **AI 요약·해설**: 3~~5문장 요약 + “왜 중요?” 2~~3문장 + 용어풀이 1\~3개(한국 관점).
* FR4 중요도 산정(출처 가중치, 중복 언급량, 키워드)으로 상위 N건 선정.
* FR5 디스코드 임베드(길이 제한 내 안전 트렁케이션).
* FR6 결과/응답 상태 DB 기록, 대상일 멱등성(Upsert).
* FR7 Jenkins 파라미터로 재처리(특정 단계/날짜) 가능.

# 6) 비기능 요구사항(NFR)

* NFR1 500건/일 처리 5분 내(평시 목표).
* NFR2 관측성: 단계별 처리건/실패건/예외사유 수집.
* NFR3 보안: API Key는 Jenkins Credentials로 주입, 로깅 최소화.
* NFR4 컴플라이언스: 전문 저장 최소화(요약·링크 중심), robots/TOS 준수.
* NFR5 비용: **소형 모델 우선 + Batch API(가능 시)**, 토큰 예산 관리. *(Batch API는 동기 대비 약 50% 비용 절감 제공)* ([OpenAI][1], [OpenAI Platform][2], [OpenAI Help Center][3])

---

## 7) OpenAI 활용 계획(성능/비용 최적화)

### 7.1 모델 운용 전략

* **2단계 라우팅**

    * **Stage A (대부분 기사)**: “미니/경량” 계열(예: *mini/경제형 모델*)로 **추출형 요약 + 구조화 JSON** 생성.
    * **Stage B (최종 상위 N건만)**: “플래그십” 계열(예: 최신 주력 모델)로 **문체 다듬기·오류 점검·맥락 강화** (입력은 Stage A 산출물 요약본으로 최소화).
* 최신 가용 모델·특성은 **공식 모델 문서/모델 목록**을 기준으로 결정(릴리스 변동 가능) ([OpenAI Platform][4])
* **Structured Outputs**로 JSON 스키마 강제 ▶ 형식 안정성 강화 ([OpenAI Platform][5], [OpenAI][6])
* **Function calling/툴콜**은 필요 시(분류·키워드 추출·룰 보정) 사용 ([OpenAI Platform][7])

### 7.2 비용 절감 장치

* **Batch API**: 시간 여유가 있는 단계(S3\_SUMMARIZE\_AI Stage A)를 **03:00 KST**에 선제 제출 → 07:10까지 결과 도착 시 사용, 미도착 시 동기 API로 폴백. *(Batch API는 동기 대비 약 50% 비용 절감 안내)* ([OpenAI][1], [OpenAI Platform][2])
* **토큰 예산화**:

    * 입력 본문은 **문장 중요도 선별(Top-k)** + 중복 제거 후 3\~5천 토큰 내 제한.
    * 출력은 600\~900 토큰 내.
* **캐싱**: (URL, Last-Modified, ETag) + (프롬프트 해시)로 재요약 방지.
* **소스 신뢰도 가중치**: 저품질/중복 소스는 요약 대상 제외.
* **레이트리밋/동시성 고려**: 조직/프로젝트 단위 제한에 맞춰 QPS 조절(모델별 상이) ([OpenAI Platform][8])

> **참고:** 세부 단가/요금표는 시점별로 변동되므로 **공식 가격 페이지** 확인·적용(필요 시 사전 승인 한도 설정) ([OpenAI][1], [OpenAI Platform][9])

---

## 8) 프롬프팅 전략(예시; 코드 아님)

### 8.1 공통 지침(System Prompt)

* 역할: “한국어 경제 해설가”.
* 스타일: **쉽고 간결**, 과장/권유 금지(투자 자문 아님), **사실 기반**.
* 금칙: 출처에 없는 수치/주장 생성 금지, 모호할 땐 “텍스트에 없음”으로 표기.
* 출력: **JSON 스키마 준수**(structured outputs). ([OpenAI Platform][5])

### 8.2 사용자 입력(User Prompt) 구성

* 메타: `title`, `source`, `published_at(KST)`, `url`, `country_hint=KR`
* 본문: 전처리된 핵심문장·인용문(최대 3\~5천 토큰)
* 태스크:

    1. **요약(3\~5문장)**: 기사에 **명시된 사실만**
    2. **왜 중요한가(2\~3문장)**: 한국 시장(코스피/원화/금리/수출입 등) 관점
    3. **핵심 포인트(3\~5개 불릿)**
    4. **용어풀이(1\~3개)**: 쉬운 한 줄 정의
    5. **출처 근거**: 사용한 문장 인덱스 배열(추적성)

### 8.3 Structured Output JSON 스키마(요지)

```json
{
  "type": "object",
  "properties": {
    "summary": {"type":"string"},
    "why_it_matters": {"type":"string"},
    "bullets": {"type":"array","items":{"type":"string"}, "minItems":3,"maxItems":5},
    "glossary": {"type":"array","items":{"type":"object","properties":{
      "term":{"type":"string"},
      "definition":{"type":"string"}
    }}, "minItems":1,"maxItems":3},
    "evidence_sentence_indexes":{"type":"array","items":{"type":"integer"}}
  },
  "required":["summary","why_it_matters","bullets","glossary"]
}
```

→ **Structured Outputs** 기능으로 스키마 강제(꼭 JSON 준수) ([OpenAI Platform][5])

### 8.4 2단계 라우팅 프롬프트

* **Stage A(미니 모델)**: 위 스키마로 **사실 요약**만.
* **Stage B(플래그십)**: Stage A 결과 + 메타(한국 독자·문장 간결화·중복 제거)로 **가독성/일관성 강화**(추가 사실 생성 금지).

---

## 9) 파이프라인 상세(Step, I/O)

* **S1\_FETCH**: RSS/공식 피드 수집 → (title, url, published\_at, source)
* **S2\_EXTRACT**: 본문 추출(허용 범위) → 문장분할/중복제거/Top-k 축약
* **S3\_SUMMARIZE\_AI**:

    * (옵션) 03:00 KST Batch 제출 → 07:10까지 수신 시 사용, 미수신 시 동기 API로 처리. ([OpenAI Platform][2])
    * Stage A: mini 모델 Structured JSON 산출
    * Stage B: 상위 N건만 플래그십 모델로 리라이팅/점검
* **S4\_RANK\_COMPOSE**: 중요도 점수→상위 N 선택→디스코드 텍스트/임베드 조립(길이 제한 안전치 적용)
* **S5\_DISPATCH**: 디스코드 웹훅 발송→응답/상태 DB 기록

---

## 10) 데이터 모델(개념)

* `articles(url UNIQUE, source, title, published_at, raw_excerpt, created_at)`
* `summaries(article_id, summary_text, why_it_matters, bullets[], glossary(jsonb[]), evidence_idx[], score, created_at)`
* `daily_digest(digest_date UNIQUE, title, body_markdown, created_at)`
* `dispatch_log(digest_id, channel, webhook_ref, status, response_snippet, created_at)`
* (옵션) `quarantine` 추출/약관 이슈 기록

---

## 11) Jenkins/운영

* 스케줄: 07:30 KST(일간), (옵션) 03:00 KST Batch 제출 작업.
* 파라미터: `targetDate`, `maxArticles`, `dryRun`, `useLLM`, `llmModelSmall`, `llmModelMain`, `webhookOverride`.
* 크리덴셜: `OPENAI_API_KEY`, DB, 프록시.
* 아티팩트: 다이제스트 MD, 전송 요청/응답 스니펫, 배치 로그.
* 레이트리밋 감안한 동시성 제어(조직/프로젝트 단위) ([OpenAI Platform][8])

---

## 12) KPI/수용 기준

* 요약 품질(UAT): “핵심 누락 없음, 근거 불일치 0건, 과장·권유 표현 0건”.
* 일정 준수: 07:35 이전 발송 성공률 ≥ 99%.
* 비용: 일일 토큰 예산 준수(월간 상한 알람).
* 안정성: 본문 추출 실패율 ≤ 20%(폴백 동작 확인).

---

## 13) 리스크/대응

* 모델/가격 변동 → **공식 모델/가격 문서**를 주기 확인해 파이프라인 변수로 관리. ([OpenAI Platform][4], [OpenAI][1])
* Batch 지연 → 07:10 타임박스, 미도착 시 동기 API 폴백.
* 약관/저작권 → 요약·링크 중심, 원문 대량 저장 금지.
* 레이트리밋 → 큐/백오프, 재시도 정책, 스로틀링. ([OpenAI Platform][8])

---

## 14) 테스트 전략

* 단위: 요약 스냅샷(Structured JSON 스키마 검증), 길이 제한/트렁케이션, 랭킹 리그레션.
* 통합: 실제 RSS 일부, LLM 스테이징 키, 디스코드 스테이징.
* 부하: 800건/일 입력에서 95p 소요시간 측정.
* 안전망: “출처에 없는 내용 추가 금지” 위반 케이스 정기 샘플링.

---

## 15) WBS(3단계)

1. 기획(주1)
   1.1 소스/가중치·템플릿 정의
   1.2 법/보안 가이드 협의
   1.3 KPI/예산 수립
2. 설계(주1)
   2.1 Batch 단계·I/O·파라미터 설계
   2.2 DB/인덱스/보존정책 설계
   2.3 **LLM 라우팅·Batch 사용·레이트리밋 제어 설계**
   2.4 Jenkins 파이프라인/크리덴셜 설계
3. 시험·운영(주1)
   3.1 스테이징 통합/UAT(드라이런)
   3.2 비용/성능 튜닝(토큰 예산·소스 필터)
   3.3 운영 매뉴얼/재처리 런북 배포

---

### 부록) 운영 시 자주 참고할 공식 문서

* **모델 목록/특성**(최신 모델 가용성 확인) ([OpenAI Platform][4])
* **API 가격/Batch 50% 할인 안내** ([OpenAI][1], [OpenAI Platform][9])
* **Structured Outputs(스키마 강제)** ([OpenAI Platform][5])
* **Batch API 가이드**(비용·처리방식) ([OpenAI Platform][2])
* **레이트리밋 가이드**(조직/프로젝트 단위) ([OpenAI Platform][8])

---

원하면 이 PRD 기반으로 \*\*상세 설계서(배치 Step별 I/O 표, 실패/스킵 규칙, 토큰 예산 수치, Jenkins 파라미터 스펙, DB 마이그레이션 스크립트 명세)\*\*까지 바로 이어서 작성해줄게.

[1]: https://openai.com/api/pricing/?utm_source=chatgpt.com "API Pricing"
[2]: https://platform.openai.com/docs/guides/batch?utm_source=chatgpt.com "Batch API"
[3]: https://help.openai.com/en/articles/9197833-batch-api-faq?utm_source=chatgpt.com "Batch API FAQ"
[4]: https://platform.openai.com/docs/models?utm_source=chatgpt.com "Models - OpenAI API"
[5]: https://platform.openai.com/docs/guides/structured-outputs?utm_source=chatgpt.com "Structured model outputs - OpenAI API"
[6]: https://openai.com/index/introducing-structured-outputs-in-the-api/?utm_source=chatgpt.com "Introducing Structured Outputs in the API"
[7]: https://platform.openai.com/docs/guides/function-calling?utm_source=chatgpt.com "Function calling - OpenAI API"
[8]: https://platform.openai.com/docs/guides/rate-limits?utm_source=chatgpt.com "Rate limits - OpenAI API"
[9]: https://platform.openai.com/docs/pricing?utm_source=chatgpt.com "Pricing - OpenAI API"
